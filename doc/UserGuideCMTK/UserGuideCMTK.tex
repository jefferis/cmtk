%
% This document is licensed under the
%
%   Creative Commons Attribution-Noncommercial-Share Alike
%
% license. Please see LICENSE file for details.
%

%
% Complete documentation on the extended LaTeX markup used for Insight
% documentation is available in ``Documenting Insight'', which is part
% of the standard documentation for Insight.  It may be found online
% at:
%
%     http://www.itk.org/

\documentclass{InsightArticle}

\usepackage[dvipdfm]{graphicx}
\usepackage{url}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
%  hyperref should be the last package to be loaded.
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\usepackage[dvipdfm,
bookmarks,
bookmarksopen,
backref,
colorlinks,linkcolor={blue},citecolor={blue},urlcolor={blue},
]{hyperref}


%  This is a template for Papers to the Insight Journal. 
%  It is comparable to a technical report format.

% The title should be descriptive enough for people to be able to find
% the relevant document. 
\title{User Guide to \\[4mm] The Computational Morphometry
  Toolkit\footnote{Continued development and maintenance of CMTK is funded by
    the NIBIB under Grant No. R01~EB008381. This document is licensed under
    the Creative Commons Attribution-Noncommercial-Share Alike (CC-NC-SA) license}}

% Increment the release number whenever significant changes are made.
% The author and/or editor can define 'significant' however they like.
\release{1.00}

% At minimum, give your name and an email address.  You can include a
% snail-mail address if you like.
\author{Torsten Rohlfing}
\authoraddress{Neuroscience Program, SRI International, Menlo Park, CA}

\begin{document}


\ifpdf
\else
   %
   % Commands for including Graphics when using latex
   % 
   \DeclareGraphicsExtensions{.eps,.jpg,.gif,.tiff,.bmp,.png}
   \DeclareGraphicsRule{.jpg}{eps}{.jpg.bb}{`convert #1 eps:-}
   \DeclareGraphicsRule{.gif}{eps}{.gif.bb}{`convert #1 eps:-}
   \DeclareGraphicsRule{.tiff}{eps}{.tiff.bb}{`convert #1 eps:-}
   \DeclareGraphicsRule{.bmp}{eps}{.bmp.bb}{`convert #1 eps:-}
   \DeclareGraphicsRule{.png}{eps}{.png.bb}{`convert #1 eps:-}
\fi


\maketitle


\ifhtml
\chapter*{Front Matter\label{front}}
\fi


% The abstract should be a paragraph or two long, and describe the
% scope of the document.
\begin{abstract}
\noindent
This paper is intended as a very brief introduction of the main tools in the
Computational Morphometry Toolkit (CMTK). The target audience are CMTK users,
who might use this codument as a reference to the most common processing
tasks, and prospective users, who may find this information useful to
determine whether CMTK provides functionality that they can use.
\end{abstract}

\tableofcontents

\section{Introduction}

The Computational Morphometry Toolkit, or short CMTK, is a set of software
tools that perform various types of processing and analysis on
three-dimensional (3D) image data. CMTK is available both in source code
(licensed under the GNU GPL3) and as pre-compiled binaries from
\url{http://www.nitrc.org/projects/cmtk/}.

\subsection{Terminology}

Regarding the roles of images in pairwise registration, throughout this guide we shall
refer to one image as the reference and the other as the floating
image. Others may refer to these as the fixed and the moving image,
respectively. By definition, all coordinate transformations computed by CMTK
are functions that map {\em from\/} the space of the reference (fixed) image
{\em to\/} the space of the floating (moving) image. As a result, when
reformatting one image to match the other, it is the floating image by default
that will be transformed to match the reference image.

Note that when we speak about transforming coordinates of features, such as
landmarks or the nodes in a mesh, then the coordinates of the reference image
will be transformed to match the floating image.

\subsection{Conventions}

For medical image data, CMTK uses an anatmoy-based coordinate system, which we
refer to as ``RAS'' coordinates. This means that the $x$ direction of the
coordinate space increases towards the anatomical ``Right,'' the $y$ direction
increases towards the anatomical ``Anterior,'' and the $z$ direction increases
towards the anatomical ``Superior.'' The coordinate space origin, $(0,0,0)$,
thus coincides with the ``Left-Posterior-Inferior'' corner of the image
volume. 

All images that are read into one of CMTK's tools are first reoriented to fit
this coordinate system. This means that the storage order of image pixels in
memory is also such that the fastest-

For image formats that define subject orientation based on direction vectors
within an anatomy-based coordinate space, CMTK determines the nearest
anatomical orientation within $\pm 45$ degrees around each rotation axis.

\section{Step-by-Step}

This section provides a step-by-step guide to the tools used in a typical
morpometry study using the CMTK tools. It is not intended to provide a
complete list of available tools.

\subsection{DICOM Image Stacker}

When dealing with 3D medical image data in particular, the first step of
processing is usually the conversion of a stack of single-slice image files in
DICOM format to a single-file 3D image. To this end, CMTK provides a tool that
can search through a file system tree, find all DICOM files in it, group the
ones that form 3D image volumes, and write each of these volumes into a
separate file in one of the supported formats.

For example, the command
\begin{verbatim}
dcm2image --recurse --out-pattern image_%02d.nii /path/to/dicom
\end{verbatim}
or short
\begin{verbatim}
dcm2image -r -O image_%02d.nii /path/to/dicom
\end{verbatim}
would recursively search the file system under {\tt /path/to/dicom} and write
all resulting image volumes to consecutively numbered image files in NIFTI
format, {\tt image\_01.nii},  {\tt image\_01.nii}, and so on.

\subsection{Interleaved Image Motion Artifact Correction}

\subsection{MR Intensity Bias Field Correction}

\begin{verbatim}
levelset levelset.nii
\end{verbatim}

\begin{verbatim}
mrbias -M 2 --mask levelset.nii spgr.nii spgr_corrected.nii
\end{verbatim}

\subsection{Affine Image Registration}


\begin{verbatim}
registration -o afine.xform --dofs 6 --dofs 9 --auto-multi-level 4 spgr1.nii spgr2.nii
\end{verbatim}

\subsection{Nonrigid Image Registration}

\cite{RuecSonoHaye:1999} \cite{RohlMaur:2003}

\begin{verbatim}
warp -o ffd.xform affine.xform
\end{verbatim}

\subsection{Atlas-based Segmentation}

\subsection{Jacobian Determinant Maps}

\subsection{Statistical Testing}

\subsection{General Linear Modeling}

\section{Atlas Construction}

\subsection{Iterative Shape Averaging}

\subsection{Averaging Pairwise Correspondences}

\subsection{Groupwise Population Registration}

\section{Quick Tool Reference}

\section*{Acknowledgments}

Much of the effort required to get CMTK ready for release as open source
software was performed by Mike Hasak at SRI. Calvin R. Maurer, Jr., wrote the
original implementation of his linear-time algorithm for the Euclidean
distance transform, which \verb|cmtk::UniformDistanceMap| is based on, and
kindly agreed to distribution of this derived code under the GPL. Likewise,
Daniel Russakoff kindly agreed to GPL licensing of code he wrote for entropy
computation based on covariance matrices, as he used it in his work on
Regional Mutual Information. Greg Jefferis provided numerous bug reports and
fixes, including much of the details required to get CMTK compiled and working
on the MacOS platform.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
%  Insert the bibliography using BibTeX
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\bibliographystyle{plain}
\bibliography{cmtk}


\end{document}

